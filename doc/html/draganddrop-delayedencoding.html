<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- delayedencoding.qdoc -->
  <title>Qt 4.7: Delayed Encoding Example</title>
  <link rel="stylesheet" type="text/css" href="style/style.css" />
  <script src="scripts/jquery.js" type="text/javascript"></script>
  <script src="scripts/functions.js" type="text/javascript"></script>
</head>
<body class="offline narrow creator">
 <div class="header" id="qtdocheader">
    <div class="content"> 
    <div id="nav-logo">
      <a href="index.html">Home</a></div>
    <a href="index.html" class="qtref"><span>Qt Reference Documentation</span></a>
    <div id="nav-topright">
      <ul>
        <li class="nav-topright-home"><a href="http://qt.nokia.com/">Qt HOME</a></li>
        <li class="nav-topright-dev"><a href="http://developer.qt.nokia.com/">DEV</a></li>
        <li class="nav-topright-labs"><a href="http://labs.qt.nokia.com/blogs/">LABS</a></li>
        <li class="nav-topright-doc nav-topright-doc-active"><a href="http://doc.qt.nokia.com/">
          DOC</a></li>
        <li class="nav-topright-blog"><a href="http://blog.qt.nokia.com/">BLOG</a></li>
      </ul>
    </div>
    <div id="shortCut">
      <ul>
        <li class="shortCut-topleft-inactive"><span><a href="index.html">Qt 4.7</a></span></li>
        <li class="shortCut-topleft-active"><a href="http://doc.qt.nokia.com">ALL VERSIONS        </a></li>
      </ul>
     </div>
 <ul class="sf-menu sf-js-enabled sf-shadow" id="narrowmenu"> 
		 <li><a href="#">API Lookup</a> 
			 <ul id="topmenuLook"> 
			   <li><a href="classes.html">Class index</a></li> 
 			  <li><a href="functions.html">Function index</a></li> 
			   <li><a href="modules.html">Modules</a></li> 
			   <li><a href="namespaces.html">Namespaces</a></li> 
			   <li><a href="qtglobal.html">Global Declarations</a></li> 
			   <li><a href="licensing.html">Licenses and Credits</a></li> 
			   </ul> 
		 </li> 
		 <li><a href="#">Qt Topics</a> 
			 <ul id="topmenuTopic"> 
			   <li><a href="qt-basic-concepts.html">Programming with Qt</a></li> 
			   <li><a href="qtquick.html">Device UI's &amp; Qt Quick</a></li> 
			   <li><a href="qt-gui-concepts.html">UI Design with Qt</a></li> 
			   <li><a href="developing-with-qt.html">Cross-platform and Platform-specific</a></li> 
			   <li><a href="platform-specific.html">Platform-specific info</a></li> 
			   <li><a href="technology-apis.html">Qt and Key Technologies</a></li> 
			   <li><a href="best-practices.html">How-To's and Best Practices</a></li> 
			 </ul> 
		</li> 
		 <li><a href="#">Examples</a> 
			 <ul id="topmenuexample"> 
				 <li><a href="all-examples.html">Examples</a></li> 
				 <li><a href="tutorials.html">Tutorials</a></li> 
				 <li><a href="demos.html">Demos</a></li> 
				 <li><a href="qdeclarativeexamples.html">QML Examples</a></li> 
			 </ul> 
		 </li> 
 </ul> 
    </div>
  </div>
  <div class="wrapper">
    <div class="hd">
      <span></span>
    </div>
    <div class="bd group">
      <div class="sidebar">
        <div class="searchlabel">
          Search index:</div>
        <div class="search">
          <form id="qtdocsearch" action="" onsubmit="return false;">
            <fieldset>
              <input type="text" name="searchstring" id="pageType" value="" />
            </fieldset>
          </form>
        </div>
        <div class="box first bottombar" id="lookup">
          <h2 title="API Lookup"><span></span>
            API Lookup</h2>
          <div  id="list001" class="list">
          <ul id="ul001" >
              <li class="defaultLink"><a href="classes.html">Class index</a></li>
              <li class="defaultLink"><a href="functions.html">Function index</a></li>
              <li class="defaultLink"><a href="modules.html">Modules</a></li>
              <li class="defaultLink"><a href="namespaces.html">Namespaces</a></li>
              <li class="defaultLink"><a href="qtglobal.html">Global Declarations</a></li>
              <li class="defaultLink"><a href="qdeclarativeelements.html">QML elements</a></li>
            </ul> 
          </div>
        </div>
        <div class="box bottombar" id="topics">
          <h2 title="Qt Topics"><span></span>
            Qt Topics</h2>
          <div id="list002" class="list">
            <ul id="ul002" >
			   <li class="defaultLink"><a href="qt-basic-concepts.html">Programming with Qt</a></li> 
			   <li class="defaultLink"><a href="qtquick.html">Device UI's &amp; Qt Quick</a></li> 
			   <li class="defaultLink"><a href="qt-gui-concepts.html">UI Design with Qt</a></li> 
			   <li class="defaultLink"><a href="developing-with-qt.html">Cross-platform and Platform-specific</a></li> 
			   <li class="defaultLink"><a href="platform-specific.html">Platform-specific info</a></li> 
			   <li class="defaultLink"><a href="technology-apis.html">Qt and Key Technologies</a></li> 
			   <li class="defaultLink"><a href="best-practices.html">How-To's and Best Practices</a></li> 
            </ul>  
          </div>
        </div>
        <div class="box" id="examples">
          <h2 title="Examples"><span></span>
            Examples</h2>
          <div id="list003" class="list">
        <ul id="ul003">
              <li class="defaultLink"><a href="all-examples.html">Examples</a></li>
              <li class="defaultLink"><a href="tutorials.html">Tutorials</a></li>
              <li class="defaultLink"><a href="demos.html">Demos</a></li>
              <li class="defaultLink"><a href="qdeclarativeexamples.html">QML Examples</a></li>
            </ul> 
          </div>
        </div>
      </div>
      <div class="wrap">
        <div class="toolbar">
          <div class="breadcrumb toolblock">
            <ul>
              <li class="first"><a href="index.html">Home</a></li>
              <!--  Bread crumbs goes here -->
              <li><a href="all-examples.html">Examples</a></li>              <li>Delayed Encoding Example</li>            </ul>
          </div>
          <div class="toolbuttons toolblock">
            <ul>
              <li id="smallA" class="t_button">A</li>
              <li id="medA" class="t_button active">A</li>
              <li id="bigA" class="t_button">A</li>
              <li id="print" class="t_button"><a href="javascript:this.print();">
                <span>Print</span></a></li>
            </ul>
        </div>
        </div>
        <div class="content">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#sourcewidget-class-definition">SourceWidget Class Definition</a></li>
<li class="level1"><a href="#sourcewidget-class-implementation">SourceWidget Class Implementation</a></li>
<li class="level1"><a href="#mimedata-class-definition">MimeData Class Definition</a></li>
<li class="level1"><a href="#mimedata-class-implementation">MimeData Class Implementation</a></li>
</ul>
</div>
<h1 class="title">Delayed Encoding Example</h1>
<span class="subtitle"></span>
<!-- $$$draganddrop/delayedencoding-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="draganddrop-delayedencoding-mimedata-cpp.html">draganddrop/delayedencoding/mimedata.cpp</a></li>
<li><a href="draganddrop-delayedencoding-mimedata-h.html">draganddrop/delayedencoding/mimedata.h</a></li>
<li><a href="draganddrop-delayedencoding-sourcewidget-cpp.html">draganddrop/delayedencoding/sourcewidget.cpp</a></li>
<li><a href="draganddrop-delayedencoding-sourcewidget-h.html">draganddrop/delayedencoding/sourcewidget.h</a></li>
<li><a href="draganddrop-delayedencoding-images-example-svg.html">draganddrop/delayedencoding/images/example.svg</a></li>
<li><a href="draganddrop-delayedencoding-main-cpp.html">draganddrop/delayedencoding/main.cpp</a></li>
<li><a href="draganddrop-delayedencoding-delayedencoding-pro.html">draganddrop/delayedencoding/delayedencoding.pro</a></li>
<li><a href="draganddrop-delayedencoding-delayedencoding-qrc.html">draganddrop/delayedencoding/delayedencoding.qrc</a></li>
</ul>
<p>Images:</p>
<ul>
<li><a href="images/used-in-examples/draganddrop/delayedencoding/images/drag.png">draganddrop/delayedencoding/images/drag.png</a></li>
</ul>
<p>The Delayed Encoding example shows how to delay preparing of data for drag and drop operations until a drop target is found.</p>
<p class="centerAlign"><img src="images/delayedecoding-example.png" /></p><p>The <b>Export</b> push button is pressed down to start the drag. The data for the drag and drop operation is not processed until the user of the application has found a valid drop target. This removes redundant processing if the operation is aborted. In our case, we have an SVG image that we wish to send as the <tt>&quot;image/png&quot;</tt> MIME type. It is the conversion from SVG to PNG we wish to delay - it can be quite expensive.</p>
<p>The example is implemented in two classes: <tt>SourceWidget</tt> and <tt>MimeData</tt>. The <tt>SourceWidget</tt> class sets up the GUI and starts the drag operation on request. The <tt>MimeData</tt> class, which inherits <a href="qmimedata.html">QMimeData</a>, sends a signal when a drop target is found. This signal is connected to a slot in <tt>SourceWidget</tt>, which does the conversion from SVG to PNG.</p>
<a name="sourcewidget-class-definition"></a>
<h2>SourceWidget Class Definition</h2>
<p>The <tt>SourceWidget</tt> class starts drag and drop operations and also does the image conversion.</p>
<pre class="highlightedCode brush: cpp"> public slots:
     void createData(const QString &amp;mimetype);
     void startDrag();

 private:
     QByteArray imageData;
     QSvgWidget *imageLabel;
     MimeData *mimeData;</pre>
<p>The <b>Export</b> push button is connected to the <tt>startDrag()</tt> slot. The <tt>createData()</tt> slot will be invoked when data for the drag and drop operation is to be created.</p>
<a name="sourcewidget-class-implementation"></a>
<h2>SourceWidget Class Implementation</h2>
<p>Let's start our code tour with a look at the <tt>startDrag()</tt> slot.</p>
<pre class="highlightedCode brush: cpp"> void SourceWidget::startDrag()
 {
     mimeData = new MimeData;

     connect(mimeData, SIGNAL(dataRequested(QString)),
             this, SLOT(createData(QString)), Qt::DirectConnection);

     QDrag *drag = new QDrag(this);
     drag-&gt;setMimeData(mimeData);
     drag-&gt;setPixmap(QPixmap(&quot;:/images/drag.png&quot;));

     drag-&gt;exec(Qt::CopyAction);
 }</pre>
<p>We emit <tt>dataRequested()</tt> from <tt>MimeData</tt> when the operation has found a valid drop target.</p>
<p>We gallop along to <tt>createData()</tt>:</p>
<pre class="highlightedCode brush: cpp"> void SourceWidget::createData(const QString &amp;mimeType)
 {
     if (mimeType != &quot;image/png&quot;)
         return;

     QImage image(imageLabel-&gt;size(), QImage::Format_RGB32);
     QPainter painter;
     painter.begin(&amp;image);
     imageLabel-&gt;renderer()-&gt;render(&amp;painter);
     painter.end();

     QByteArray data;
     QBuffer buffer(&amp;data);
     buffer.open(QIODevice::WriteOnly);
     image.save(&amp;buffer, &quot;PNG&quot;);
     buffer.close();

     mimeData-&gt;setData(&quot;image/png&quot;, data);
 }</pre>
<p>Fortunately, Qt provides <a href="qsvgrenderer.html">QSvgRenderer</a>, which can render the SVG image to any <a href="qpaintdevice.html">QPaintDevice</a>. Also, <a href="qimage.html">QImage</a> has no problems saving to the PNG format.</p>
<p>Finally, we can give the data to <tt>MimeData</tt>.</p>
<a name="mimedata-class-definition"></a>
<h2>MimeData Class Definition</h2>
<p>The <tt>MimeData</tt> class inherits <a href="qmimedata.html">QMimeData</a> and makes it possible to delay preparing of the data for a drag and drop operation.</p>
<pre class="highlightedCode brush: cpp"> class MimeData : public QMimeData
 {
     Q_OBJECT

 public:
     MimeData();
     QStringList formats() const;

 signals:
     void dataRequested(const QString &amp;mimeType) const;

 protected:
     QVariant retrieveData(const QString &amp;mimetype, QVariant::Type type) const;
 };</pre>
<p>We will look closer at <tt>retrieveData()</tt> and <tt>formats()</tt> in the next section.</p>
<a name="mimedata-class-implementation"></a>
<h2>MimeData Class Implementation</h2>
<pre class="highlightedCode brush: cpp"> QStringList MimeData::formats() const
 {
     return QMimeData::formats() &lt;&lt; &quot;image/png&quot;;
 }</pre>
<p>In the <tt>formats()</tt> function, we return the format of the data we provide. This is the <tt>image/png</tt> MIME type.</p>
<pre class="highlightedCode brush: cpp"> QVariant MimeData::retrieveData(const QString &amp;mimeType, QVariant::Type type)
          const
 {
     emit dataRequested(mimeType);

     return QMimeData::retrieveData(mimeType, type);
 }</pre>
<p><tt>retrieveData()</tt> is reimplemented from <a href="qmimedata.html">QMimeData</a> and is called when the data is requested by the drag and drop operation. Fortunately for us, this happens when the operation is finishing, i.e&#x2e;, when a drop target has been found.</p>
<p>We emit the <tt>dataRequested()</tt> signal, which is picked up by <tt>SourceWidget</tt>. The <tt>SourceWidget</tt> (as already explained) sets the data on <tt>MimeData</tt> with <a href="qmimedata.html#setData">setData()</a>.</p>
</div>
<!-- @@@draganddrop/delayedencoding -->
        <div class="feedback t_button">
          [+] Documentation Feedback</div>
      </div>
    </div>
    </div> 
    <div class="ft">
      <span></span>
    </div>
  </div> 
  <div class="footer">
    <p>
      <acronym title="Copyright">&copy;</acronym> 2008-2010 Nokia Corporation and/or its
      subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
      in Finland and/or other countries worldwide.</p>
    <p>
      All other trademarks are property of their respective owners. <a title="Privacy Policy"
        href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
    <br />
    <p>
      Licensees holding valid Qt Commercial licenses may use this document in accordance with the      Qt Commercial License Agreement provided with the Software or, alternatively, in accordance      with the terms contained in a written agreement between you and Nokia.</p>
    <p>
      Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
      Free Documentation License version 1.3</a>
      as published by the Free Software Foundation.</p>
  </div>
  <div id="feedbackBox">
      <div id="feedcloseX" class="feedclose t_button">X</div>
    <form id="feedform" action="http://doc.qt.nokia.com/docFeedbck/feedback.php" method="get">
      <p id="noteHead">Thank you for giving your feedback.</p> <p class="note">Make sure it is related to this specific page. For more general bugs and 
      requests, please use the <a href="http://bugreports.qt.nokia.com/secure/Dashboard.jspa">Qt Bug Tracker</a>.</p>
      <p><textarea id="feedbox" name="feedText" rows="5" cols="40"></textarea></p>
      <p><input id="feedsubmit" class="feedclose" type="submit" name="feedback" /></p>
    </form>
  </div>
  <div id="blurpage">
  </div>
</body>
</html>
