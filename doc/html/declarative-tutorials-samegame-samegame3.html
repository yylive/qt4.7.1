<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- advtutorial.qdoc -->
  <title>Qt 4.7: QML Advanced Tutorial 3 - Implementing the Game Logic</title>
  <link rel="stylesheet" type="text/css" href="style/style.css" />
  <script src="scripts/jquery.js" type="text/javascript"></script>
  <script src="scripts/functions.js" type="text/javascript"></script>
</head>
<body class="offline narrow creator">
 <div class="header" id="qtdocheader">
    <div class="content"> 
    <div id="nav-logo">
      <a href="index.html">Home</a></div>
    <a href="index.html" class="qtref"><span>Qt Reference Documentation</span></a>
    <div id="nav-topright">
      <ul>
        <li class="nav-topright-home"><a href="http://qt.nokia.com/">Qt HOME</a></li>
        <li class="nav-topright-dev"><a href="http://developer.qt.nokia.com/">DEV</a></li>
        <li class="nav-topright-labs"><a href="http://labs.qt.nokia.com/blogs/">LABS</a></li>
        <li class="nav-topright-doc nav-topright-doc-active"><a href="http://doc.qt.nokia.com/">
          DOC</a></li>
        <li class="nav-topright-blog"><a href="http://blog.qt.nokia.com/">BLOG</a></li>
      </ul>
    </div>
    <div id="shortCut">
      <ul>
        <li class="shortCut-topleft-inactive"><span><a href="index.html">Qt 4.7</a></span></li>
        <li class="shortCut-topleft-active"><a href="http://doc.qt.nokia.com">ALL VERSIONS        </a></li>
      </ul>
     </div>
 <ul class="sf-menu sf-js-enabled sf-shadow" id="narrowmenu"> 
		 <li><a href="#">API Lookup</a> 
			 <ul id="topmenuLook"> 
			   <li><a href="classes.html">Class index</a></li> 
 			  <li><a href="functions.html">Function index</a></li> 
			   <li><a href="modules.html">Modules</a></li> 
			   <li><a href="namespaces.html">Namespaces</a></li> 
			   <li><a href="qtglobal.html">Global Declarations</a></li> 
			   <li><a href="licensing.html">Licenses and Credits</a></li> 
			   </ul> 
		 </li> 
		 <li><a href="#">Qt Topics</a> 
			 <ul id="topmenuTopic"> 
			   <li><a href="qt-basic-concepts.html">Programming with Qt</a></li> 
			   <li><a href="qtquick.html">Device UI's &amp; Qt Quick</a></li> 
			   <li><a href="qt-gui-concepts.html">UI Design with Qt</a></li> 
			   <li><a href="developing-with-qt.html">Cross-platform and Platform-specific</a></li> 
			   <li><a href="platform-specific.html">Platform-specific info</a></li> 
			   <li><a href="technology-apis.html">Qt and Key Technologies</a></li> 
			   <li><a href="best-practices.html">How-To's and Best Practices</a></li> 
			 </ul> 
		</li> 
		 <li><a href="#">Examples</a> 
			 <ul id="topmenuexample"> 
				 <li><a href="all-examples.html">Examples</a></li> 
				 <li><a href="tutorials.html">Tutorials</a></li> 
				 <li><a href="demos.html">Demos</a></li> 
				 <li><a href="qdeclarativeexamples.html">QML Examples</a></li> 
			 </ul> 
		 </li> 
 </ul> 
    </div>
  </div>
  <div class="wrapper">
    <div class="hd">
      <span></span>
    </div>
    <div class="bd group">
      <div class="sidebar">
        <div class="searchlabel">
          Search index:</div>
        <div class="search">
          <form id="qtdocsearch" action="" onsubmit="return false;">
            <fieldset>
              <input type="text" name="searchstring" id="pageType" value="" />
            </fieldset>
          </form>
        </div>
        <div class="box first bottombar" id="lookup">
          <h2 title="API Lookup"><span></span>
            API Lookup</h2>
          <div  id="list001" class="list">
          <ul id="ul001" >
              <li class="defaultLink"><a href="classes.html">Class index</a></li>
              <li class="defaultLink"><a href="functions.html">Function index</a></li>
              <li class="defaultLink"><a href="modules.html">Modules</a></li>
              <li class="defaultLink"><a href="namespaces.html">Namespaces</a></li>
              <li class="defaultLink"><a href="qtglobal.html">Global Declarations</a></li>
              <li class="defaultLink"><a href="qdeclarativeelements.html">QML elements</a></li>
            </ul> 
          </div>
        </div>
        <div class="box bottombar" id="topics">
          <h2 title="Qt Topics"><span></span>
            Qt Topics</h2>
          <div id="list002" class="list">
            <ul id="ul002" >
			   <li class="defaultLink"><a href="qt-basic-concepts.html">Programming with Qt</a></li> 
			   <li class="defaultLink"><a href="qtquick.html">Device UI's &amp; Qt Quick</a></li> 
			   <li class="defaultLink"><a href="qt-gui-concepts.html">UI Design with Qt</a></li> 
			   <li class="defaultLink"><a href="developing-with-qt.html">Cross-platform and Platform-specific</a></li> 
			   <li class="defaultLink"><a href="platform-specific.html">Platform-specific info</a></li> 
			   <li class="defaultLink"><a href="technology-apis.html">Qt and Key Technologies</a></li> 
			   <li class="defaultLink"><a href="best-practices.html">How-To's and Best Practices</a></li> 
            </ul>  
          </div>
        </div>
        <div class="box" id="examples">
          <h2 title="Examples"><span></span>
            Examples</h2>
          <div id="list003" class="list">
        <ul id="ul003">
              <li class="defaultLink"><a href="all-examples.html">Examples</a></li>
              <li class="defaultLink"><a href="tutorials.html">Tutorials</a></li>
              <li class="defaultLink"><a href="demos.html">Demos</a></li>
              <li class="defaultLink"><a href="qdeclarativeexamples.html">QML Examples</a></li>
            </ul> 
          </div>
        </div>
      </div>
      <div class="wrap">
        <div class="toolbar">
          <div class="breadcrumb toolblock">
            <ul>
              <li class="first"><a href="index.html">Home</a></li>
              <!--  Bread crumbs goes here -->
              <li><a href="all-examples.html">Examples</a></li>              <li><a href="qdeclarativeexamples.html">QML Examples &amp; Demos</a></li>              <li>QML Advanced Tutorial 3 - Implementing the Game Logic</li>            </ul>
          </div>
          <div class="toolbuttons toolblock">
            <ul>
              <li id="smallA" class="t_button">A</li>
              <li id="medA" class="t_button active">A</li>
              <li id="bigA" class="t_button">A</li>
              <li id="print" class="t_button"><a href="javascript:this.print();">
                <span>Print</span></a></li>
            </ul>
        </div>
        </div>
        <div class="content">
  <link rel="prev" href="declarative-tutorials-samegame-samegame2.html" />
  <link rel="next" href="declarative-tutorials-samegame-samegame4.html" />
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#making-a-playable-game">Making a playable game</a></li>
<li class="level2"><a href="#enabling-mouse-click-interaction">Enabling mouse click interaction</a></li>
<li class="level2"><a href="#updating-the-score">Updating the score</a></li>
<li class="level2"><a href="#a-dash-of-color">A dash of color</a></li>
<li class="level1"><a href="#a-working-game">A working game</a></li>
</ul>
</div>
<h1 class="title">QML Advanced Tutorial 3 - Implementing the Game Logic</h1>
<span class="subtitle"></span>
<!-- $$$declarative/tutorials/samegame/samegame3-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="declarative-tutorials-samegame-samegame3-block-qml.html">declarative/tutorials/samegame/samegame3/Block.qml</a></li>
<li><a href="declarative-tutorials-samegame-samegame3-button-qml.html">declarative/tutorials/samegame/samegame3/Button.qml</a></li>
<li><a href="declarative-tutorials-samegame-samegame3-dialog-qml.html">declarative/tutorials/samegame/samegame3/Dialog.qml</a></li>
<li><a href="declarative-tutorials-samegame-samegame3-samegame-js.html">declarative/tutorials/samegame/samegame3/samegame.js</a></li>
<li><a href="declarative-tutorials-samegame-samegame3-samegame-qml.html">declarative/tutorials/samegame/samegame3/samegame.qml</a></li>
</ul>
<a name="making-a-playable-game"></a>
<h2>Making a playable game</h2>
<p>Now that we have all the game components, we can add the game logic that dictates how a player interacts with the blocks and plays the game until it is won or lost.</p>
<p>To do this, we have added the following functions to <tt>samegame.js</tt>:</p>
<ul>
<li><tt>handleClick(x,y)</tt></li>
<li><tt>floodFill(xIdx,yIdx,type)</tt></li>
<li><tt>shuffleDown()</tt></li>
<li><tt>victoryCheck()</tt></li>
<li><tt>floodMoveCheck(xIdx, yIdx, type)</tt></li>
</ul>
<p>As this is a tutorial about QML, not game design, we will only discuss <tt>handleClick()</tt> and <tt>victoryCheck()</tt> below since they interface directly with the QML elements. Note that although the game logic here is written in <a href="https://developer.mozilla.org/en/JavaScript">JavaScript</a>, it could have been written in C++ and then exposed to QML.</p>
<a name="enabling-mouse-click-interaction"></a>
<h3>Enabling mouse click interaction</h3>
<p>To make it easier for the <a href="https://developer.mozilla.org/en/JavaScript">JavaScript</a> code to interface with the QML elements, we have added an Item called <tt>gameCanvas</tt> to <tt>samegame.qml</tt>. It replaces the background as the item which contains the blocks. It also accepts mouse input from the user. Here is the item code:</p>
<pre class="highlightedCode brush: cpp">         Item {
             id: gameCanvas

             property int score: 0
             property int blockSize: 40

             width: parent.width - (parent.width % blockSize)
             height: parent.height - (parent.height % blockSize)
             anchors.centerIn: parent

             MouseArea {
                 anchors.fill: parent
                 onClicked: SameGame.handleClick(mouse.x, mouse.y)
             }
         }</pre>
<p>The <tt>gameCanvas</tt> item is the exact size of the board, and has a <tt>score</tt> property and a <a href="qml-mousearea.html">MouseArea</a> to handle mouse clicks. The blocks are now created as its children, and its dimensions are used to determine the board size so that the application scales to the available screen size. Since its size is bound to a multiple of <tt>blockSize</tt>, <tt>blockSize</tt> was moved out of <tt>samegame.js</tt> and into <tt>samegame.qml</tt> as a QML property. Note that it can still be accessed from the script.</p>
<p>When clicked, the <a href="qml-mousearea.html">MouseArea</a> calls <tt>handleClick()</tt> in <tt>samegame.js</tt>, which determines whether the player's click should cause any blocks to be removed, and updates <tt>gameCanvas.score</tt> with the current score if necessary. Here is the <tt>handleClick()</tt> function:</p>
<pre class="highlightedCode brush: cpp"> function handleClick(xPos, yPos) {
     var column = Math.floor(xPos / gameCanvas.blockSize);
     var row = Math.floor(yPos / gameCanvas.blockSize);
     if (column &gt;= maxColumn || column &lt; 0 || row &gt;= maxRow || row &lt; 0)
         return;
     if (board[index(column, row)] == null)
         return;
     //If it's a valid block, remove it and all connected (does nothing if it's not connected)
     floodFill(column, row, -1);
     if (fillFound &lt;= 0)
         return;
     gameCanvas.score += (fillFound - 1) * (fillFound - 1);
     shuffleDown();
     victoryCheck();
 }</pre>
<p>Note that if <tt>score</tt> was a global variable in the <tt>samegame.js</tt> file you would not be able to bind to it. You can only bind to QML properties.</p>
<a name="updating-the-score"></a>
<h3>Updating the score</h3>
<p>When the player clicks a block and triggers <tt>handleClick()</tt>, <tt>handleClick()</tt> also calls <tt>victoryCheck()</tt> to update the score and to check whether the player has completed the game. Here is the <tt>victoryCheck()</tt> code:</p>
<pre class="highlightedCode brush: cpp"> function victoryCheck() {
     //Award bonus points if no blocks left
     var deservesBonus = true;
     for (var column = maxColumn - 1; column &gt;= 0; column--)
         if (board[index(column, maxRow - 1)] != null)
         deservesBonus = false;
     if (deservesBonus)
         gameCanvas.score += 500;

     //Check whether game has finished
     if (deservesBonus || !(floodMoveCheck(0, maxRow - 1, -1)))
         dialog.show(&quot;Game Over. Your score is &quot; + gameCanvas.score);
 }</pre>
<p>This updates the <tt>gameCanvas.score</tt> value and displays a &quot;Game Over&quot; dialog if the game is finished.</p>
<p>The Game Over dialog is created using a <tt>Dialog</tt> element that is defined in <tt>Dialog.qml</tt>. Here is the <tt>Dialog.qml</tt> code. Notice how it is designed to be usable imperatively from the script file, via the functions and signals:</p>
<pre class="highlightedCode brush: cpp"> import QtQuick 1.0

 Rectangle {
     id: container

     function show(text) {
         dialogText.text = text;
         container.opacity = 1;
     }

     function hide() {
         container.opacity = 0;
     }

     width: dialogText.width + 20
     height: dialogText.height + 20
     opacity: 0

     Text {
         id: dialogText
         anchors.centerIn: parent
         text: &quot;&quot;
     }

     MouseArea {
         anchors.fill: parent
         onClicked: hide();
     }
 }</pre>
<p>And this is how it is used in the main <tt>samegame.qml</tt> file:</p>
<pre class="highlightedCode brush: cpp">     Dialog {
         id: dialog
         anchors.centerIn: parent
         z: 100
     }</pre>
<p>We give the dialog a <a href="qml-item.html#z-prop">z</a> value of 100 to ensure it is displayed on top of our other components. The default <tt>z</tt> value for an item is 0.</p>
<a name="a-dash-of-color"></a>
<h3>A dash of color</h3>
<p>It's not much fun to play Same Game if all the blocks are the same color, so we've modified the <tt>createBlock()</tt> function in <tt>samegame.js</tt> to randomly create a different type of block (for either red, green or blue) each time it is called. <tt>Block.qml</tt> has also changed so that each block contains a different image depending on its type:</p>
<pre class="highlightedCode brush: cpp"> import QtQuick 1.0

 Item {
     id: block

     property int type: 0

     Image {
         id: img

         anchors.fill: parent
         source: {
             if (type == 0)
                 return &quot;../shared/pics/redStone.png&quot;;
             else if (type == 1)
                 return &quot;../shared/pics/blueStone.png&quot;;
             else
                 return &quot;../shared/pics/greenStone.png&quot;;
         }
     }
 }</pre>
<a name="a-working-game"></a>
<h2>A working game</h2>
<p>Now we now have a working game! The blocks can be clicked, the player can score, and the game can end (and then you can start a new one). Here is a screenshot of what has been accomplished so far:</p>
<p class="centerAlign"><img src="images/declarative-adv-tutorial3.png" /></p><p>This is what <tt>samegame.qml</tt> looks like now:</p>
<pre class="highlightedCode brush: cpp"> import QtQuick 1.0
 import &quot;samegame.js&quot; as SameGame

 Rectangle {
     id: screen

     width: 490; height: 720

     SystemPalette { id: activePalette }

     Item {
         width: parent.width
         anchors { top: parent.top; bottom: toolBar.top }

         Image {
             id: background
             anchors.fill: parent
             source: &quot;../shared/pics/background.jpg&quot;
             fillMode: Image.PreserveAspectCrop
         }

         Item {
             id: gameCanvas

             property int score: 0
             property int blockSize: 40

             width: parent.width - (parent.width % blockSize)
             height: parent.height - (parent.height % blockSize)
             anchors.centerIn: parent

             MouseArea {
                 anchors.fill: parent
                 onClicked: SameGame.handleClick(mouse.x, mouse.y)
             }
         }
     }

     Dialog {
         id: dialog
         anchors.centerIn: parent
         z: 100
     }

     Rectangle {
         id: toolBar
         width: parent.width; height: 30
         color: activePalette.window
         anchors.bottom: screen.bottom

         Button {
             anchors { left: parent.left; verticalCenter: parent.verticalCenter }
             text: &quot;New Game&quot;
             onClicked: SameGame.startNewGame()
         }

         Text {
             id: score
             anchors { right: parent.right; verticalCenter: parent.verticalCenter }
             text: &quot;Score: Who knows?&quot;
         }
     }
 }</pre>
<p>The game works, but it's a little boring right now. Where are the smooth animated transitions? Where are the high scores? If you were a QML expert you could have written these in the first iteration, but in this tutorial they've been saved until the next chapter - where your application becomes alive!</p>
</div>
<!-- @@@declarative/tutorials/samegame/samegame3 -->
<p>
[Previous: <a href="declarative-tutorials-samegame-samegame2.html">QML Advanced Tutorial 2 - Populating the Game Canvas</a>]
[Next: <a href="declarative-tutorials-samegame-samegame4.html">QML Advanced Tutorial 4 - Finishing Touches</a>]
</p>
        <div class="feedback t_button">
          [+] Documentation Feedback</div>
      </div>
    </div>
    </div> 
    <div class="ft">
      <span></span>
    </div>
  </div> 
  <div class="footer">
    <p>
      <acronym title="Copyright">&copy;</acronym> 2008-2010 Nokia Corporation and/or its
      subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
      in Finland and/or other countries worldwide.</p>
    <p>
      All other trademarks are property of their respective owners. <a title="Privacy Policy"
        href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
    <br />
    <p>
      Licensees holding valid Qt Commercial licenses may use this document in accordance with the      Qt Commercial License Agreement provided with the Software or, alternatively, in accordance      with the terms contained in a written agreement between you and Nokia.</p>
    <p>
      Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
      Free Documentation License version 1.3</a>
      as published by the Free Software Foundation.</p>
  </div>
  <div id="feedbackBox">
      <div id="feedcloseX" class="feedclose t_button">X</div>
    <form id="feedform" action="http://doc.qt.nokia.com/docFeedbck/feedback.php" method="get">
      <p id="noteHead">Thank you for giving your feedback.</p> <p class="note">Make sure it is related to this specific page. For more general bugs and 
      requests, please use the <a href="http://bugreports.qt.nokia.com/secure/Dashboard.jspa">Qt Bug Tracker</a>.</p>
      <p><textarea id="feedbox" name="feedText" rows="5" cols="40"></textarea></p>
      <p><input id="feedsubmit" class="feedclose" type="submit" name="feedback" /></p>
    </form>
  </div>
  <div id="blurpage">
  </div>
</body>
</html>
